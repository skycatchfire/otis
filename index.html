<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <title>GitHub Project Card Creator</title>
</head>
  <body class="bg-gray-100"  x-data="{ open: false }" x-init="
    if (!localStorage.getItem('token') ||
        !localStorage.getItem('project-number') ||
        !localStorage.getItem('organization')) {
        open = true;
    }
">

    <button @click="open = true" class="text-3xl fixed top-2 right-2 size-10 flex items-center justify-center">
      <span>⚙️</span>
      <span class="sr-only">Settings</span>
    </button>


    <div class="relative z-10 duration-300 ease-in-out transtion-all opacity-0 pointer-events-none" role="dialog" aria-modal="true" :class="open && '!opacity-100 pointer-events-auto'">
      <div class="fixed inset-0 overflow-hidden">
        <div class="absolute inset-0 bg-black/40 overflow-hidden">
          <div class="pointer-events-none  fixed inset-y-0 right-0 flex max-w-full pl-10 sm:pl-16">
            <div class="pointer-events-auto w-screen max-w-md transform transition ease-in-out duration-500 sm:duration-700" :class="open ? 'translate-x-0' : 'translate-x-full'">
              <div class="flex h-full flex-col overflow-y-scroll bg-white shadow-xl">
                <div class="px-4 py-6 sm:px-6">
                  <div class="flex items-start justify-between">
                    <h2 id="slide-over-heading" class="text-base font-semibold leading-6 text-gray-900">Settings</h2>
                    <div class="ml-3 flex h-7 items-center">
                      <button type="button" @click="open = false" class="relative rounded-md bg-white text-gray-400 hover:text-gray-500 focus:ring-2 focus:ring-indigo-500">
                        <span class="absolute -inset-2.5"></span>
                        <span class="sr-only">Close panel</span>
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
                <!-- Main -->
                <div class="px-4 py-6 px-6">
                  <div class="pb-1 sm:pb-6">
                    <div class="flex flex-col gap-5">
                      <div class="grow shrink-0">
                        <label class="block text-sm font-medium leading-6 text-gray-900" for="project-number">GitHub Project #</label>
                        <input class="mt-2 block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-indigo-600 sm:text-sm sm:leading-6" type="number" name="project-number" id="project-number">
                      </div>

                      <div class="grow shrink-0">
                        <label for="organization" class="block text-sm font-medium leading-6 text-gray-900">GitHub Organization</label>
                        <div class="mt-2">
                          <input type="organization" name="organization" id="organization" class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6" required>
                        </div>
                      </div>

                      <div>
                        <label for="token" class="block text-sm font-medium leading-6 text-gray-900">GitHub Personal Access Token</label>
                        <input type="password" id="token" value="" class="mt-2 block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6" required>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="max-w-lg px-4 mx-auto w-full my-20">
      <h1 class="text-4xl font-bold text-center my-8">GitHub Project Card Creator</h1>
        <form id="cardForm" class="flex flex-col gap-5">
          <div>
            <label for="template" class="block text-sm font-medium leading-6 text-gray-900">Template</label>
            <select id="template" name="template" class="mt-2 block w-full rounded-md border-0 py-1.5 pl-3 pr-10 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm sm:leading-6">
              <option value="" selected>Select a template</option>
            </select>
          </div>

          <div>
            <label for="title" class="block text-sm font-medium leading-6 text-gray-900">Title</label>
            <div class="mt-2">
              <input type="title" name="title" id="title" class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6" required>
            </div>
          </div>

          <div>
            <label for="content" class="block text-sm font-medium leading-6 text-gray-900">Content</label>

            <textarea id="content" rows="4" class="mt-2 block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6 resize-y" required></textarea>
          </div>

          <div>
            <label for="imageUrl" class="block text-sm font-medium leading-6 text-gray-900">Image URL</label>
            <input type="file" id="imageUrl" name="imageUrl" class="mt-2 block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-indigo-50 hover:file:bg-indigo-900" multiple>
          </div>

          <div id="dynamicFields" class="flex flex-col gap-5"></div>

          <button type="submit" class="mt-4 rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-900 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-900">Create Card</button>
        </form>

        <div id="result"></div>
    </div>

     <script>
        const form = document.getElementById('cardForm');
        const imageUrlInput = document.getElementById('imageUrl');
        const resultDiv = document.getElementById('result');
        var projectFields = [];
        var projectID = "";
        var projectNumber;
        var organization;
        const templates = [
            {
                id: '1',
                title: "Component - COPY ME",
                content: "Mocks\n-----\n\n### ScreenShots\n\n### Requirements\n\n- [ ] Check comments in Invision for requirements\n\n\n### CMS\n- [ ] Build ACF Group\n- [ ] Build Group Fields\n- [ ] Set section to \"inactive\" so it only shows when added to page sections\n- [ ] Add To page sections\n- [ ] Add `aq_resize` to images ex: `<?php print aq_resize($image['url'], 450, 450, true); ?>`\n- [ ] Add `Content Tab`, `Settings Tab` and settings fields. (if applicable)\n\n\n### Development\n- [ ] Develop Desktop\n- [ ] Develop Tablet\n- [ ] Develop Mobile\n- [ ] Find and develop all variants\n- [ ] Add section to appropriate pages on Dev site\n- [ ] If using background image, add role=\"img\" and aria-label attribute value to element\n- [ ] Never use `the_field()`. Only use `get_field()`\n- [ ] Apply HTML escaping wherever HTML is rendered by ACF.\n- [ ] escape and hardcoded text. `_e('the text', 'fire');`\n\n\n### Testing\n- [ ] **Test multiple variations for sections.** Try things like different copy length, with and without images, etc. Try to break the section, by using it how it wasn't intended. Don't assume the mock will always be how it's used.\n- [ ] Check aXe for general accessibility & semantics (ADA).\n- [ ] Test Large Desktop (1920)\n- [ ] Test Medium Desktop (1440)\n- [ ] Test Small Desktop (1280)\n- [ ] Test Desktop: Chrome\n- [ ] Test Desktop: FireFox\n- [ ] Test Desktop: Safari\n- [ ] Test Desktop: Edge\n- [ ] Test iPad\n- [ ] Test iPhone\n- [ ] Test Android\n- [ ] Run `npm run build` and make sure nothing you need got purged",
                presetCustomFields: {
                    status: [{id:"c864437f", fieldName: 'status'}],
                    cardType: [{id:"6fe5e32e", fieldName: 'card-type'}],
                    cycle: [{id:"e6e7689e", fieldName: 'cycle'}],
                    hoursEstimated: [{value: 4, fieldName: 'hours-estimated'}]
                },
            },
            {
                id: '2',
                title: "Page - COPY ME",
                content: "### Content Entry\n- [ ] Create the page\n- [ ] Add all sections to the page\n- [ ] Populate all sections with real content\n- [ ] Add desktop gaps between sections to match mockups\n- [ ] Add tablet gaps between sections to match mockups\n- [ ] Add mobile gaps between sections to match mockups",
                presetCustomFields: {
                    status: [{id:"c864437f", fieldName: 'status'}],
                    cardType: [{id:"590da93e", fieldName: 'card-type'}],
                    cycle: [{id:"e6e7689e", fieldName: 'cycle'}],
                    hoursEstimated: [{value: 4, fieldName: 'hours-estimated'}]
                },
            },
            {
                id: '3',
                title: "Taxonomy Type - COPY ME",
                content: "### Checklist\n- [ ] Create Taxonomy using ACF\n- [ ] Add post type specific fields using ACF\n- [ ] Saved/Committed the exported post type field json\n- [ ] Hide from search if needed.",
                presetCustomFields: {
                    status: [{id:"c864437f", fieldName: 'status'}],
                    cardType: [{id:"590da93e", fieldName: 'card-type'}],
                    cycle: [{id:"e6e7689e", fieldName: 'cycle'}],
                    hoursEstimated: [{value: 4, fieldName: 'hours-estimated'}]
                },
            },
            {
                id: '4',
                title: "Post Type - COPY ME",
                content: "###Checklist\n- [ ] Create Post type using ACF\n- [ ] Add post type specific fields using ACF\n- [ ] Saved/Committed the exported post type field json\n- [ ] Add slug rewrites if needed.\n- [ ] Hide from search if needed.\n- [ ] Should the post have a url? if not disable \"Public\" in the ACF options",
                presetCustomFields: {
                    status: [{id:"c864437f", fieldName: 'status'}],
                    cardType: [{id:"590da93e", fieldName: 'card-type'}],
                    cycle: [{id:"e6e7689e", fieldName: 'cycle'}],
                    hoursEstimated: [{value: 4, fieldName: 'hours-estimated'}]
                },
            }
        ];

        function populateTemplates() {
            const templateSelect = document.getElementById('template');
            templates.forEach(template => {
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = template.title;
                templateSelect.appendChild(option);
            });
        }

        populateTemplates();

        document.getElementById('template').addEventListener('change', (e) => {
            const selectedTemplate = templates.find(t => t.id === e.target.value);
            if (selectedTemplate) {
                document.getElementById('title').value = selectedTemplate.title;
                document.getElementById('content').value = selectedTemplate.content;

                if (selectedTemplate.presetCustomFields) {
                    for (const field of projectFields) {
                        const presetField = Object.values(selectedTemplate.presetCustomFields).flat().find(f => f.fieldName === field.name.toLowerCase().replace(/\s+/g, '-'));
                        if (presetField) {
                            if (field.dataType === 'NUMBER' && field.name.toLowerCase().replace(/\s+/g, '-') === 'hours-estimated') {
                                const input = document.querySelector(`input[name="${field.name.toLowerCase().replace(/\s+/g, '-')}"]`);
                                if (input) {
                                    input.value = presetField.value;
                                }
                            } else {
                                const select = document.querySelector(`select[name="${field.name.toLowerCase().replace(/\s+/g, '-')}"]`);
                                if (select) {
                                    select.value = presetField.id;
                                }
                            }
                        }
                    }
                }

            }
        });

        async function fetchProjectFields(token) {
            const query = `
            query {
                organization(login: "${organization}") {
                    projectV2(number: ${projectNumber}) {
                        id
                        title
                        fields(first: 100) {
                            nodes {
                                ... on ProjectV2Field { id name dataType }
                                ... on ProjectV2IterationField { id name dataType configuration { iterations { title startDate id } } }
                                ... on ProjectV2SingleSelectField { id name dataType options { id name } }
                            }
                        }
                    }
                }
            }`;

            const response = await fetch('https://api.github.com/graphql', {
                method: 'POST',
                headers: {
                    'Authorization': `bearer ${token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query }),
            });

            const data = await response.json();
            projectID = data.data.organization.projectV2.id;
            console.log(data.data.organization.projectV2.fields.nodes);
            return data.data.organization.projectV2.fields.nodes.filter(field =>
                field.dataType === 'SINGLE_SELECT' ||
                field.dataType === 'NUMBER' ||
                field.dataType === 'ITERATION'
            );
        }

        function createSelectElement(field) {
            const select = document.createElement('select');
            select.className = 'mt-2 block w-full rounded-md border-0 py-1.5 pl-3 pr-10 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm sm:leading-6';
            select.name = field.name.toLowerCase().replace(/\s+/g, '-');
            select.id = select.name;

            const label = document.createElement('label');
            label.className = 'block text-sm font-medium leading-6 text-gray-900';
            label.htmlFor = select.id;
            label.textContent = field.name + ':';

            const wrapper = document.createElement('div');
            wrapper.appendChild(label);
            wrapper.appendChild(select);

            return wrapper;
        }

        function createNumberElement(field) {
            const input = document.createElement('input');
            input.className = 'mt-2 block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-indigo-600 sm:text-sm sm:leading-6';
            input.type = 'number';
            input.name = field.name.toLowerCase().replace(/\s+/g, '-');
            input.id = input.name;

            const label = document.createElement('label');
            label.className = 'block text-sm font-medium leading-6 text-gray-900';
            label.htmlFor = input.id;
            label.textContent = field.name + ':';

            const wrapper = document.createElement('div');
            wrapper.appendChild(label);
            wrapper.appendChild(input);

            return wrapper;
        }

        async function populateForm(token) {
            projectFields = await fetchProjectFields(token);

            const dynamicFieldsContainer = document.getElementById('dynamicFields');
            dynamicFieldsContainer.innerHTML = '';

            for (const field of projectFields) {
                if(field.dataType === 'SINGLE_SELECT' || field.dataType === 'ITERATION') {
                    const options = field.dataType === 'SINGLE_SELECT' ? field.options : field.configuration.iterations;
                    if (options && options.length > 0) {
                        const selectWrapper = createSelectElement(field);
                        dynamicFieldsContainer.appendChild(selectWrapper);

                        const select = selectWrapper.querySelector('select');
                        select.innerHTML = '<option value="">Select a ' + field.name + '</option>';
                        options.forEach(option => {
                            const el = document.createElement('option');
                            el.value = option.id;
                            el.textContent = field.dataType === 'SINGLE_SELECT' ? option.name : option.title;
                            select.appendChild(el);
                        });
                    }
                } else {
                    const numberWrapper = createNumberElement(field);
                    dynamicFieldsContainer.appendChild(numberWrapper);
                }
            }
        }

        async function updateProjectFields(token, itemId, fields) {
            for (const field of fields) {
                let mutation = `
                mutation {
                    updateProjectV2ItemFieldValue(input: {
                        projectId: "${projectID}"
                        itemId: "${itemId}"
                        fieldId: "${field.fieldId}"
                        value: { ${field.value} }
                    }) {
                        projectV2Item {
                            id
                        }
                    }
                }`;

                try {
                    const response = await fetch('https://api.github.com/graphql', {
                        method: 'POST',
                        headers: {
                            'Authorization': `bearer ${token}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ query: mutation }),
                    });

                    const data = await response.json();
                    console.log(`Update ${field.fieldId} Response:`, data);
                } catch (error) {
                    console.error(`Error updating field ${field.fieldId}:`, error);
                }
            }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            resultDiv.innerHTML = ''; // Clear previous results

            const title = document.getElementById('title').value.trim();
            const content = document.getElementById('content').value.trim();
            const token = document.getElementById('token').value.trim();
            const organization = document.getElementById('organization').value.trim();
            const projectNumber = document.getElementById('project-number').value.trim();
            const images = Array.from(imageUrlInput.files).map(file => URL.createObjectURL(file));

            if (!title || !content || !token) {
                resultDiv.innerHTML = '<div class="class="pointer-events-auto flex items-center justify-between gap-x-6 bg-red-400 px-6 py-2.5 sm:rounded-xl sm:py-3 sm:pl-4 sm:pr-3.5 text-sm leading-6 text-white">Error: All fields except Hours Estimated are required.</div>';
                return;
            }

            const mutation = `
            mutation {
                addProjectV2DraftIssue(input: {
                    projectId: "${projectID}"
                    title: "${title}"
                    body: "${content.replace(/"/g, '\\"')}\\n\\n${images.map(url => `![Image](${url})`).join('\\n')}"
                }) {
                    projectItem {
                        id
                    }
                }
            }`;

            try {
                const response = await fetch('https://api.github.com/graphql', {
                    method: 'POST',
                    headers: {
                        'Authorization': `bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: mutation }),
                });

                const data = await response.json();
                const itemId = data.data.addProjectV2DraftIssue.projectItem.id;

                // Collect field values dynamically
                const fieldsToUpdate = [];
                    projectFields.forEach(field => {
                        const fieldName = field.name.toLowerCase().replace(/\s+/g, '-');
                        if (field.dataType === 'SINGLE_SELECT') {
                            const select = document.querySelector(`select[name="${fieldName}"]`);
                            if (select && select.value) {
                                fieldsToUpdate.push({
                                    fieldId: field.id,
                                    value: `singleSelectOptionId: "${select.value}"`
                                });
                            }
                        } else if (field.dataType === 'ITERATION') {
                            const select = document.querySelector(`select[name="${fieldName}"]`);
                            if (select && select.value) {
                                fieldsToUpdate.push({
                                    fieldId: field.id,
                                    value: `iterationId: "${select.value}"`
                                });
                            }
                        } else if (field.dataType === 'NUMBER') {
                            const input = document.querySelector(`input[name="${fieldName}"]`);
                            if (input && input.value) {
                                fieldsToUpdate.push({
                                    fieldId: field.id,
                                    value: `number: ${input.value}`
                                });
                            }
                        }
                    });
                console.log(fieldsToUpdate);


                await updateProjectFields(token, itemId, fieldsToUpdate);

                resultDiv.innerHTML = `<div class="class="pointer-events-auto flex items-center justify-between gap-x-6 bg-green-400 px-6 py-2.5 sm:rounded-xl sm:py-3 sm:pl-4 sm:pr-3.5 text-sm leading-6 text-white">Card created successfully! ID: ${title}</div>`;
            } catch (error) {
                resultDiv.innerHTML = `<div class="class="pointer-events-auto flex items-center justify-between gap-x-6 bg-red-400 px-6 py-2.5 sm:rounded-xl sm:py-3 sm:pl-4 sm:pr-3.5 text-sm leading-6 text-white">Error creating card: ${error.message}</div>`;
            }
        });

        if (localStorage.getItem('token')) {
          document.getElementById('token').value = localStorage.getItem('token');
        }
        if(localStorage.getItem('project-number')) {
          projectNumber = parseInt(localStorage.getItem('project-number'));
          document.getElementById('project-number').value = projectNumber;
        }
        if(localStorage.getItem('organization')) {
          organization = localStorage.getItem('organization');
          document.getElementById('organization').value = organization;
        }

        if(localStorage.getItem('token') && localStorage.getItem('project-number') && localStorage.getItem('organization')) {
          populateForm(localStorage.getItem('token'));
        }

      function checkAndPopulateForm() {
        const token = localStorage.getItem('token');
        const projectNumber = localStorage.getItem('project-number');
        const organization = localStorage.getItem('organization');

        if (token && projectNumber && organization) {
            populateForm(token);
        }
      }

      document.getElementById('token').addEventListener('change', (e) => {
        localStorage.setItem('token', e.target.value);
        checkAndPopulateForm();
      });

      document.getElementById('project-number').addEventListener('change', (e) => {
        localStorage.setItem('project-number', e.target.value);
        checkAndPopulateForm();
      });

      document.getElementById('organization').addEventListener('change', (e) => {
        localStorage.setItem('organization', e.target.value);
        checkAndPopulateForm();
      });
    </script>
  </body>
</html>